# Deep Analysis & Implementation Plan: Wine Inventory AI + Syrve Integration

## 1. Current State Analysis
I have analyzed the database schema from migration files and the current TypeScript definitions.

**Status: Schema Conflict Detected**
*   **Path A (Current Frontend):** The `types.ts` file and Phase 1 migrations define a **Domain-Specific Wine Schema** (`wines`, `wine_variants`, `inventory_items` with open/closed counts). This aligns perfectly with your "Wine Restaurant" requirements and User Flows.
*   **Path B (Universal Migration):** The `20240211...universal_schema.sql` proposes dropping the `wines` table in favor of a generic `products` table with JSONB data. **Critical Warning:** Adopting this generic schema would destroy the specific fields (vintage, grapes, regions) needed for your Wine Platform features.

**Recommendation:** We must **REJECT** the generic `products` table approach and instead **EXTEND** the rich `wines` schema to support Syrve integration. This gives you the best of both worlds: rich wine data for your app, and seamless syncing with Syrve.

## 2. Gap Analysis (Missing Components)

| Feature Area | Current Status | Missing / Needs Implementation |
| :--- | :--- | :--- |
| **Syrve Integration** | `syrve_product_id` exists in `wine_variants`. | Missing core config tables: `integration_syrve_config`, `integration_syrve_stores`, `integration_syrve_sync_log`. Need a robust mapping system. |
| **Inventory Counts** | `inventory_items` has basic structure. | Need to verify `quantity_opened` vs `quantity_unopened` logic is fully supported in *all* views (movements, snapshots). |
| **Business/Settings** | Basic `app_settings` table exists. | Need expanded `business_profile` for restaurant specific metadata (logo, address, tax settings separate from Syrve). |
| **Reference Data** | `grape_varieties`, `producers` exist. | Need to populate these with initial seed data or sync logic from Syrve groups. |
| **AI/OCR** | Migration file exists (`2026...`) but types are missing. | Need to confirm tables are created and accessible to frontend. |

## 3. Implementation Plan

### Step 1: Database Schema Consolidation (The "Wine-First" Schema)
We will execute a new migration that ensures the `wines` table remains the core, while adding the missing Syrve integration layer.
*   **Create/Verify** `integration_syrve_*` tables.
*   **Create** `business_profile` table.
*   **Enhance** `wines` table with any missing Syrve fields (e.g., `syrve_balance`, `last_synced_at`).

### Step 2: Syrve Integration Logic
*   Implement the `SyrveSync` logic:
    *   **Pull:** Syrve Products → Map to `wines` (or create new).
    *   **Push:** Inventory Counts → Syrve Documents.
    *   **Auth:** SHA1 hash + Token flow (as per your doc).

### Step 3: AI & OCR Layer
*   Ensure `ai_recognition_attempts` and `ai_config` are active.
*   Link AI results to `wines` for auto-matching.

### Step 4: Frontend Alignment
*   Update `types.ts` to reflect the new consolidated schema.
*   Update "Start Count" flow to use the split `open`/`closed` logic.

## 4. Next Action
I will now generate the **Consolidated SQL Migration** to fill all identified gaps and align the DB with your Platform vision. This will create the Syrve tables and ensure the Wine structure is preserved.